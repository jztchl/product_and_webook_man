<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>Product Manager</title>
<style>
    body { font-family: Arial, sans-serif; padding: 20px; max-width: 1000px; margin: auto; }
    .section { margin-bottom: 40px; }
    .progress-bar { width: 100%; background: #eee; height: 20px; border-radius: 4px; overflow: hidden; }
    .progress { height: 100%; width: 0%; background: green; transition: width 0.2s; }
    table { width: 100%; border-collapse: collapse; margin-top: 10px; }
    th, td { padding: 8px; border-bottom: 1px solid #ddd; text-align: left; vertical-align: middle; }
    button { padding: 6px 12px; margin: 5px; cursor: pointer; }
    .modal { display: none; position: fixed; top: 0; left: 0; right: 0; bottom: 0;
        background: rgba(0,0,0,0.6); justify-content: center; align-items: center; }
    .modal-content { background: #fff; padding: 20px; border-radius: 5px; width: 400px; }
    input[type="text"], input[type="number"], select { padding: 6px; margin: 4px 0; width: 100%; box-sizing: border-box; }
    .small { font-size: 13px; color: #666; margin-left: 6px; }
    .row { display:flex; gap:10px; align-items:center; }
    .col { flex:1; }
    .muted { color:#666; font-size:13px; }
</style>
</head>
<body>

<h2>ðŸ“¦ Product Importer & Manager</h2>

<!-- UPLOAD -->
<div class="section">
    <h3>Upload CSV</h3>
    <input type="file" id="csv-file"><br><br>
    <button onclick="uploadCSV()">Upload</button>
    <button onclick="retryUpload()" id="retry-btn" style="display:none;">Retry</button>

    <div class="progress-bar">
        <div id="progress" class="progress"></div>
    </div>
    <p id="progress-text">Waiting...</p>
</div>

<hr>

<!-- CREATE PRODUCT -->
<div class="section">
    <h3>Create Product</h3>
    <div style="display: flex; align-items: center;">
        <label for="c-sku" style="width: 100px;">SKU:</label>
        <input id="c-sku" placeholder="SKU" style="flex: 1;">
    </div>
    <div style="display: flex; align-items: center;">
        <label for="c-name" style="width: 100px;">Name:</label>
        <input id="c-name" placeholder="Name" style="flex: 1;">
    </div>
    <div style="display: flex; align-items: center;">
        <label for="c-desc" style="width: 100px;">Description:</label>
        <input id="c-desc" placeholder="Description" style="flex: 1;">
    </div>
    <div style="display: flex; align-items: center;">
        <label for="c-price" style="width: 100px;">Price:</label>
        <input id="c-price" type="number" placeholder="Price" style="flex: 1;">
    </div>
    <button onclick="createProduct()">Create</button>
</div>

<hr>

<!-- FILTERS -->
<div class="section">
    <h3>Products</h3>

    <input id="filter-sku" placeholder="Filter SKU">
    <input id="filter-name" placeholder="Filter Name">
    <input id="filter-desc" placeholder="Filter Description">
    <select id="filter-active">
        <option value="">Active?</option>
        <option value="true">Active</option>
        <option value="false">Inactive</option>
    </select>
    <button onclick="loadProducts()">Search</button>
    <button onclick="deleteAll()">Delete All</button>

    <table id="product-table">
        <thead>
            <tr>
                <th>SKU</th>
                <th>Name</th>
                <th>Description</th>
                <th>Price</th>
                <th>Active</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>

    <button onclick="prevPage()">Prev</button>
    <button onclick="nextPage()">Next</button>
</div>

<hr>

<!-- WEBHOOKS -->
<div class="section">
    <h3>Webhooks</h3>

    <h4>Create Webhook</h4>
    <div class="row" style="margin-bottom:8px;">
        <div class="col">
            <input id="w-url" type="text" placeholder="Webhook URL (https://...)">
        </div>
        <div style="width:220px;">
            <input id="w-event" type="text" placeholder="Event type (product_created)">
            <div class="small muted">Examples: product_created, product_updated, product_deleted, product_imported</div>
        </div>
        <div style="width:120px;">
            <select id="w-active">
                <option value="true">Active</option>
                <option value="false">Inactive</option>
            </select>
        </div>
        <div style="width:120px;">
            <button onclick="createWebhook()">Create</button>
        </div>
    </div>

    <table id="webhook-table">
        <thead>
            <tr>
                <th>URL</th>
                <th>Event</th>
                <th>Active</th>
                <th>Created</th>
                <th>Actions</th>
            </tr>
        </thead>
        <tbody></tbody>
    </table>
</div>

<!-- UPDATE MODAL -->
<div id="update-modal" class="modal">
    <div class="modal-content">
        <h3>Update Product</h3>
        <div style="display: flex; align-items: center;">
            <label for="u-name" style="width: 100px;">Name:</label>
            <input id="u-name" placeholder="Name" style="flex: 1;"><br>
        </div>
        <div style="display: flex; align-items: center;">
            <label for="u-desc" style="width: 100px;">Description:</label>
            <input id="u-desc" placeholder="Description" style="flex: 1;"><br>
        </div>
        <div style="display: flex; align-items: center;">
            <label for="u-price" style="width: 100px;">Price:</label>
            <input id="u-price" type="number" placeholder="Price" style="flex: 1;"><br>
        </div>
        <button onclick="saveUpdate()">Save</button>
        <button onclick="closeModal()">Cancel</button>
    </div>
</div>

<script>
const BASE = "http://localhost:8000";
let pageOffset = 0;
const PAGE_LIMIT = 20;
let updateId = null;

/* ------------------- UPLOAD + SSE ------------------ */
function uploadCSV() {
    const file = document.getElementById("csv-file").files[0];
    if (!file) { alert("Select a file first."); return; }

    const fd = new FormData();
    fd.append("file", file);

    document.getElementById("progress-text").innerText = "Uploading...";
    document.getElementById("progress").style.width = "0%";
    document.getElementById("retry-btn").style.display = "none";

    fetch(BASE + "/upload/", { method: "POST", body: fd })
        .then(async (r) => {
            if (!r.ok) {
                const err = await r.json().catch(() => ({ detail: "Upload failed" }));
                throw new Error(err.detail || "Upload failed");
            }
            return r.json();
        })
        .then((d) => {
            alert("Upload started!");
            listenProgress(d.task_id);
        })
        .catch((err) => {
            alert("âŒ Upload failed: " + err.message);
            document.getElementById("progress-text").innerText = "Upload failed.";
            document.getElementById("retry-btn").style.display = "inline-block";
        });
}

function retryUpload() {
    uploadCSV();
}

function listenProgress(taskId) {
    const evt = new EventSource(BASE + `/stream/progress/${taskId}`);

    evt.onmessage = evtMsg => {
        const data = JSON.parse(evtMsg.data);

        document.getElementById("progress").style.width = data.percent + "%";
        document.getElementById("progress-text").innerText =
            `${data.status} - ${data.percent}%`;

        if (data.percent >= 100) {
            evt.close();
            alert("âœ” Import Completed!");
            loadProducts();
            loadWebhooks();
        }
    };
}

/* ------------------- CREATE ------------------ */
function createProduct() {
    const body = {
        sku: document.getElementById("c-sku").value,
        name: document.getElementById("c-name").value,
        description: document.getElementById("c-desc").value,
        price: Number(document.getElementById("c-price").value),
        active: true
    };

    fetch(BASE + "/products/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    })
    .then(async (r) => {
        if (!r.ok) {
            const e = await r.json();
            alert("âŒ Error: " + (e.detail || e.message));
            return;
        }
        alert("âœ… Product created!");
        loadProducts();
        loadWebhooks();
    });
}

/* ------------------- LIST ------------------ */
function loadProducts() {
    const params = new URLSearchParams({
        skip: pageOffset,
        limit: PAGE_LIMIT,
        sku: document.getElementById("filter-sku").value,
        name: document.getElementById("filter-name").value,
        description: document.getElementById("filter-desc").value
    });

    const activeValue = document.getElementById("filter-active").value;
    if (activeValue === "true" || activeValue === "false") {
        params.append("active", activeValue);
    }

    fetch(BASE + "/products/list?" + params.toString())
        .then(r => r.json())
        .then(p => renderProducts(p));
}

function renderProducts(list) {
    const tbody = document.querySelector("#product-table tbody");
    tbody.innerHTML = "";

    if (!Array.isArray(list)) {
        alert("âŒ Error loading products.");
        console.error("Expected array, got:", list);
        return;
    }

    list.forEach(p => {
        const tr = document.createElement("tr");

        tr.innerHTML = `
            <td>${p.sku}</td>
            <td>${p.name || ""}</td>
            <td>${p.description || ""}</td>
            <td>${p.price}</td>
            <td>${p.active}</td>
            <td>
                <button onclick="openUpdate('${p.id}', '${escapeJs(p.name)}', '${escapeJs(p.description)}', '${p.price}')">Update</button>
                <button onclick="toggleActive('${p.id}', ${p.active})">${p.active ? 'Deactivate' : 'Activate'}</button>
                <button onclick="deleteProduct('${p.id}')">Delete</button>
            </td>
        `;

        tbody.appendChild(tr);
    });
}

function escapeJs(str) {
    if (!str && str !== "") return "";
    return String(str).replace(/'/g, "\\'").replace(/\n/g, "\\n").replace(/\r/g, "\\r");
}

function nextPage() {
    pageOffset += PAGE_LIMIT;
    loadProducts();
}

function prevPage() {
    if (pageOffset >= PAGE_LIMIT) pageOffset -= PAGE_LIMIT;
    loadProducts();
}

/* ------------------- UPDATE ------------------ */
function openUpdate(id, name, desc, price) {
    updateId = id;
    document.getElementById("u-name").value = name || "";
    document.getElementById("u-desc").value = desc || "";
    document.getElementById("u-price").value = price || 0;
    document.getElementById("update-modal").style.display = "flex";
}

function saveUpdate() {
    const body = {
        name: document.getElementById("u-name").value,
        description: document.getElementById("u-desc").value,
        price: Number(document.getElementById("u-price").value)
    };

    fetch(BASE + `/products/update/${updateId}`, {
        method: "PUT",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    })
    .then(async r => {
        if (!r.ok) {
            const e = await r.json();
            alert("âŒ Update failed: " + (e.detail || e.message));
            console.log(e);
            return;
        }
        alert("âœ… Updated!");
        closeModal();
        loadProducts();
        loadWebhooks();
    });
}

function closeModal() {
    document.getElementById("update-modal").style.display = "none";
}

/* ------------------- ACTIVE ------------------ */
function toggleActive(id, currentActive) {
    const newActive = !currentActive;

    fetch(BASE + `/products/set_status/${id}`, {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify({ status: newActive })
    })
    .then(async r => {
        if (!r.ok) {
            const e = await r.json();
            alert("âŒ Failed to change status: " + (e.detail || e.message));
            return;
        }
        alert(`âœ” Status updated to: ${newActive ? "Active" : "Inactive"}`);
        loadProducts();
        loadWebhooks();
    });
}

/* ------------------- DELETE ------------------ */
function deleteProduct(id) {
    fetch(BASE + `/products/delete/${id}`, { method: "DELETE" })
        .then(async (r) => {
            if (!r.ok) {
                const e = await r.json();
                alert("âŒ Delete failed: " + (e.detail || e.message));
                return;
            }
            alert("ðŸ—‘ Deleted!");
            loadProducts();
            loadWebhooks();
        });
}

function deleteAll() {
    const text = prompt("Type: delete all products");
    if (text !== "delete all products") return;

    fetch(BASE + `/products/delete/delete_all?msg=${text}`, { method: "DELETE" })
        .then(async r => {
            if (!r.ok) {
                const e = await r.json();
                alert("âŒ Failed to delete all: " + (e.detail || e.message));
                return;
            }
            alert("ðŸ’¥ All products deleted!");
            loadProducts();
            loadWebhooks();
        });
}

/* ------------------- WEBHOOKS ------------------ */
function loadWebhooks() {
    fetch(BASE + "/webhooks/list")
        .then(async r => {
            if (!r.ok) {
                alert("âŒ Failed to load webhooks.");
                return [];
            }
            return r.json();
        })
        .then(list => renderWebhooks(list))
        .catch(err => {
            console.error("loadWebhooks error", err);
            alert("âŒ Error loading webhooks");
        });
}

function renderWebhooks(list) {
    const tbody = document.querySelector("#webhook-table tbody");
    tbody.innerHTML = "";

    if (!Array.isArray(list)) {
        alert("âŒ Error loading webhooks.");
        console.error("Expected array, got:", list);
        return;
    }

    list.forEach(w => {
        const tr = document.createElement("tr");
        const created = w.created_at ? new Date(w.created_at).toLocaleString() : "";
        const activeLabel = w.active ? "Deactivate" : "Activate";

        tr.innerHTML = `
            <td style="max-width:300px; word-break:break-all;">${w.url}</td>
            <td>${w.event_type}</td>
            <td>${w.active}</td>
            <td>${created}</td>
            <td>
                <button onclick="testWebhook('${w.id}')">Test</button>
                <button onclick="toggleWebhook('${w.id}', ${w.active})">${activeLabel}</button>
                <button onclick="deleteWebhook('${w.id}')">Delete</button>
            </td>
        `;
        tbody.appendChild(tr);
    });
}


function createWebhook() {
    const body = {
        url: document.getElementById("w-url").value,
        event_type: document.getElementById("w-event").value,
        active: document.getElementById("w-active").value === "true"
    };

    fetch(BASE + "/webhooks/create", {
        method: "POST",
        headers: { "Content-Type": "application/json" },
        body: JSON.stringify(body)
    })
    .then(async r => {
        if (!r.ok) {
            const e = await r.json().catch(() => ({ detail: "Failed" }));
            alert("âŒ Failed to create webhook: " + (e.detail || e.message));
            return;
        }
        alert("âœ… Webhook created!");
        document.getElementById("w-url").value = "";
        document.getElementById("w-event").value = "";
        loadWebhooks();
    })
    .catch(err => { console.error(err); alert("âŒ Error creating webhook"); });
}

function deleteWebhook(id) {
    if (!confirm("Delete webhook?")) return;

    fetch(BASE + `/webhooks/delete/${id}`, { method: "DELETE" })
        .then(async r => {
            if (!r.ok) {
                const e = await r.json();
                alert("âŒ Delete failed: " + (e.detail || e.message));
                return;
            }
            alert("ðŸ—‘ Webhook deleted");
            loadWebhooks();
        })
        .catch(err => { console.error(err); alert("âŒ Error deleting webhook"); });
}

function testWebhook(id) {
    // immediate feedback to user (sync test)
    fetch(BASE + `/webhooks/test/${id}`, { method: "POST" })
        .then(async r => {
            if (!r.ok) {
                const e = await r.json().catch(() => ({ body: "No response" }));
                alert("âŒ Test failed: " + (e.body || e.detail || "unknown"));
                return;
            }
            const result = await r.json();
            alert(`Test result:\nStatus: ${result.status}\nTime: ${result.response_time_ms || 'N/A'} ms\nBody: ${String(result.body).slice(0, 500)}`);
            loadWebhooks();
        })
        .catch(err => {
            console.error("testWebhook err", err);
            alert("âŒ Test failed: " + (err.message || "Network error"));
        });
}

async function toggleWebhook(id, currentActive) {
    const newStatus = !currentActive;

    try {
        const res = await fetch(BASE + `/webhooks/set_status/${id}`, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ status: newStatus })
        });

        if (!res.ok) {
            const text = await res.text().catch(() => "Unknown error");
            alert("âŒ Failed to change status: " + text);
            return;
        }

        const data = await res.json();
        alert(`âœ” Webhook ${data.status ? "activated" : "deactivated"}`);
        loadWebhooks();
    } catch (err) {
        console.error("toggleWebhook err", err);
        alert("âŒ Network error changing status: " + (err.message || err));
    }
}


/* ------------------- INIT ------------------ */
window.addEventListener("load", () => {
    loadProducts();
    loadWebhooks();
});
</script>

</body>
</html>
